- name: Blue Green Deployment
  hosts: web
  become: true

  vars:
    app_dir: /home/ec2-user/app
    active_file: /home/ec2-user/active_env

  tasks:

    # -------------------------------------------------
    # 1️⃣ Ensure active_env file exists (default blue)
    # -------------------------------------------------
    - name: Ensure active_env file exists
      copy:
        dest: "{{ active_file }}"
        content: "blue"
        force: no

    # -------------------------------------------------
    # 2️⃣ Read which environment is active
    # -------------------------------------------------
    - name: Read active environment
      command: cat {{ active_file }}
      register: active_env

    - name: Show current active env
      debug:
        msg: "Current active env is {{ active_env.stdout }}"

    - name: Decide next environment
      set_fact:
        next_env: "{{ 'green' if active_env.stdout == 'blue' else 'blue' }}"

    - name: Show next env
      debug:
        msg: "Deploying to {{ next_env }} environment"

    # -------------------------------------------------
    # ⭐ 3️⃣ Pull latest project code on EC2 (VERY IMPORTANT)
    # -------------------------------------------------
    - name: Pull latest project repo
      git:
        repo: https://github.com/naimeshpatel5295/Dockerize-app.git
        dest: "{{ app_dir }}"
        version: main
        force: yes

    # -------------------------------------------------
    # 4️⃣ Pull latest Docker image
    # -------------------------------------------------
    - name: Pull latest image
      command: docker pull naimeshpatel5295/devnotes:latest

    # -------------------------------------------------
    # 5️⃣ Start NEW environment
    # -------------------------------------------------
    - name: Start new environment container
      command: docker compose up -d app_{{ next_env }}
      args:
        chdir: "{{ app_dir }}"

    # -------------------------------------------------
    # 6️⃣ Wait for new app to become ready
    # -------------------------------------------------
    - name: Wait for new app to start
      wait_for:
        host: localhost
        port: "{{ '5002' if next_env == 'green' else '5001' }}"
        delay: 10
        timeout: 60

    # -------------------------------------------------
    # 7️⃣ Switch NGINX traffic
    # -------------------------------------------------
    - name: Switch Nginx upstream
      shell: |
        if [ "{{ next_env }}" = "green" ]; then
          sed -i 's/server app_blue:5000/# server app_blue:5000/' {{ app_dir }}/nginx/default.conf
          sed -i 's/# server app_green:5000/server app_green:5000/' {{ app_dir }}/nginx/default.conf
        else
          sed -i 's/server app_green:5000/# server app_green:5000/' {{ app_dir }}/nginx/default.conf
          sed -i 's/# server app_blue:5000/server app_blue:5000/' {{ app_dir }}/nginx/default.conf
        fi

    - name: Reload nginx container
      command: docker compose restart nginx
      args:
        chdir: "{{ app_dir }}"

    # -------------------------------------------------
    # 8️⃣ Stop OLD environment safely
    # -------------------------------------------------
    - name: Stop old environment container
      block:
        - name: Stop old container
          command: docker stop app_{{ active_env.stdout }}
      rescue:
        - name: Old container already stopped
          debug:
            msg: "Container app_{{ active_env.stdout }} was not running, skipping stop."

    # -------------------------------------------------
    # 9️⃣ Save new active environment
    # -------------------------------------------------
    - name: Save new active environment
      copy:
        dest: "{{ active_file }}"
        content: "{{ next_env }}"
